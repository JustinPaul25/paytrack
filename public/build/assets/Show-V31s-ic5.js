import{d as ce,v as me,m as I,G as H,s as pe,p as $,q as fe,A as _e,c as y,o as l,w as n,a,b as s,e as c,f as m,u,g as ve,t as i,S as z,h as d,n as W,F as L,r as M,H as Y,x as G,y as Q,W as J}from"./app-qA0CnBWe.js";import{_ as k}from"./index-DKsLgjKN.js";import{p as ge,q as ye,r as he,_ as xe}from"./AppLayout.vue_vue_type_script_setup_true_lang-BLollNnU.js";import{_ as C,a as j}from"./CardContent.vue_vue_type_script_setup_true_lang-DFxNC8fq.js";import{_ as B,a as S}from"./CardTitle.vue_vue_type_script_setup_true_lang-PsohhGio.js";import{_ as K}from"./Label.vue_vue_type_script_setup_true_lang-BTmEbTpp.js";import{S as v}from"./sweetalert2.esm.all-BQIkj5Wb.js";import"./LocationInput.vue_vue_type_style_index_0_scoped_85568d9b_lang-C02RUasq.js";import"./useForwardPropsEmits-CwUzb49y.js";import"./DropdownMenuTrigger.vue_vue_type_script_setup_true_lang-CLRWpV5h.js";import"./Teleport-DIfWgdf9.js";import"./RovingFocusGroup-gU1KHB92.js";import"./VisuallyHidden-qt70HzaR.js";import"./DialogPortal-BX8gIO6T.js";import"./x-Da1o-ysX.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-B1dhHsl6.js";import"./chevron-down-CCBk2xD7.js";import"./chevron-right-r24-WVSv.js";const be={class:"flex items-center justify-between mb-6"},we={class:"text-2xl font-bold"},ke={class:"flex gap-2"},Ce={class:"mb-6 flex items-center gap-4"},je={key:0,class:"bg-red-50 border border-red-200 rounded-md px-4 py-2"},Be={class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},Se={class:"lg:col-span-2 space-y-6"},Ae={class:"flex items-start gap-4"},Te={class:"flex-1"},Re={class:"text-lg font-semibold"},$e={key:0,class:"text-sm text-gray-600"},Oe={class:"text-sm text-gray-600 mt-1"},Pe={key:1,class:"text-sm text-gray-600"},qe={key:2,class:"text-sm text-gray-600 mt-2"},De={class:"text-sm whitespace-pre-wrap"},Ie={class:"space-y-4"},Ee={class:"flex justify-between items-start"},Ne={class:"flex-1"},Ve={class:"font-medium"},Fe={class:"text-sm text-gray-600"},Ue={key:0,class:"text-sm text-gray-600"},He={key:1,class:"text-sm text-red-600 font-medium mt-1"},ze={class:"text-right"},We={class:"font-medium"},Le={class:"text-sm text-gray-600"},Me={class:"mt-6 pt-4 border-t"},Ye={class:"flex justify-end"},Ge={class:"text-right space-y-1"},Qe={key:0,class:"text-sm text-gray-600"},Je={class:"text-lg font-semibold"},Ke={class:"text-sm text-red-600 whitespace-pre-wrap"},Xe={class:"space-y-6"},Ze={class:"font-medium"},et={class:"font-medium capitalize"},tt={class:"font-medium"},st={key:0},rt={class:"font-medium"},ot={key:1},nt={class:"font-medium"},at={key:2},it={key:0,class:"space-y-4 mb-6 max-h-[400px] overflow-y-auto","data-comments-container":""},lt={class:"flex items-start justify-between mb-2"},ut={class:"font-medium text-sm"},dt={key:0,class:"text-xs text-blue-600 ml-2"},ct={key:1,class:"text-xs text-gray-600 ml-2"},mt={class:"text-xs text-gray-500"},pt={class:"text-sm whitespace-pre-wrap mt-2"},ft={key:1,class:"text-sm text-gray-500 mb-6 text-center py-4"},_t={class:"flex justify-end"},vt={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},gt={class:"flex gap-2 justify-end"},It=ce({__name:"Show",props:{order:{},hasStockIssues:{type:Boolean}},setup(X){var V,F;const f=X,h=me(),Z=Array.isArray((V=h.props.auth)==null?void 0:V.userRoles)&&h.props.auth.userRoles.includes("Customer"),x=Array.isArray((F=h.props.auth)==null?void 0:F.userRoles)&&(h.props.auth.userRoles.includes("Admin")||h.props.auth.userRoles.includes("Staff")),O=I(!1),b=H({rejection_reason:""}),g=H({comment:""}),p=I([...f.order.comments||[]]),t=I({...f.order});pe(()=>f.order.comments,r=>{r&&Array.isArray(r)&&(r.forEach(e=>{p.value.find(o=>o.id===e.id)||p.value.push(e)}),p.value.sort((e,o)=>new Date(e.created_at).getTime()-new Date(o.created_at).getTime()))},{deep:!0});const ee=[{title:"Orders",href:"/orders"},{title:f.order.reference_number,href:`/orders/${f.order.id}`}];function te(r){switch(r){case"pending":return"bg-yellow-100 text-yellow-800";case"approved":return"bg-green-100 text-green-800";case"rejected":return"bg-red-100 text-red-800";case"cancelled":return"bg-gray-100 text-gray-800";default:return"bg-gray-100 text-gray-800"}}function P(r){return new Intl.NumberFormat("en-PH",{style:"currency",currency:"PHP",minimumFractionDigits:2}).format(r)}function D(r){return new Date(r).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}function E(r){if(!r.media||r.media.length===0)return null;const e=r.media.find(o=>o.mime_type&&o.mime_type.startsWith("image/"));return e?e.thumb_url||e.original_url:null}function se(r){return r.name.split(" ").map(e=>e.charAt(0)).join("").toUpperCase().slice(0,2)}function N(r){const e=[];return r.address&&e.push(r.address),r.purok&&e.push(`Purok ${r.purok}`),r.barangay&&e.push(`Barangay ${r.barangay}`),r.city_municipality&&e.push(r.city_municipality),r.province&&e.push(r.province),e.length>0?e.join(", "):""}function re(){v.fire({title:"Approve this order?",text:"This will check product availability, deduct stock, and create an invoice.",icon:"question",showCancelButton:!0,confirmButtonColor:"#10b981",cancelButtonColor:"#6b7280",confirmButtonText:"Yes, approve",cancelButtonText:"Cancel"}).then(r=>{r.isConfirmed&&J.post(route("orders.approve",f.order.id),{},{preserveScroll:!0,onSuccess:()=>{v.fire({toast:!0,position:"top-end",icon:"success",title:"Order approved",text:"Invoice has been created successfully.",showConfirmButton:!1,timer:3e3,timerProgressBar:!0})},onError:e=>{v.fire({icon:"error",title:"Approval failed",text:e.stock||"Unable to approve order. Please check product availability."})}})})}function oe(){if(!b.rejection_reason.trim()){v.fire({icon:"warning",title:"Rejection reason required",text:"Please provide a reason for rejecting this order."});return}v.fire({title:"Reject this order?",text:"This action cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#ef4444",cancelButtonColor:"#6b7280",confirmButtonText:"Yes, reject",cancelButtonText:"Cancel"}).then(r=>{r.isConfirmed&&b.post(route("orders.reject",f.order.id),{preserveScroll:!0,onSuccess:()=>{O.value=!1,b.reset(),v.fire({toast:!0,position:"top-end",icon:"success",title:"Order rejected",showConfirmButton:!1,timer:3e3,timerProgressBar:!0})}})})}function ne(){v.fire({title:"Cancel this order?",text:"This action cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#ef4444",cancelButtonColor:"#6b7280",confirmButtonText:"Yes, cancel",cancelButtonText:"No"}).then(r=>{r.isConfirmed&&J.post(route("orders.cancel",f.order.id),{},{preserveScroll:!0,onSuccess:()=>{v.fire({toast:!0,position:"top-end",icon:"success",title:"Order cancelled",showConfirmButton:!1,timer:3e3,timerProgressBar:!0})}})})}const q=$(()=>f.hasStockIssues!==void 0?f.hasStockIssues:t.value.order_items.some(r=>r.quantity>r.product.stock));$(()=>x&&t.value.status==="pending"&&!q.value);const ae=$(()=>x&&t.value.status==="pending"),ie=$(()=>Z||x?t.value.status==="pending":!1),le=$(()=>t.value.vat_rate>0&&t.value.subtotal_amount>0?t.value.subtotal_amount*(t.value.vat_rate/100):0);function ue(){var o,_;if(!g.comment.trim()){v.fire({icon:"warning",title:"Comment required",text:"Please enter a comment."});return}(o=h.props.auth)==null||o.user;const r=((_=h.props.auth)==null?void 0:_.userRoles)||[];r.includes("Admin")||r.includes("Staff");const e=g.comment;g.post(route("orders.comments.store",f.order.id),{preserveScroll:!0,onSuccess:R=>{const w=R.props.order;if(w!=null&&w.comments&&Array.isArray(w.comments)){const U=w.comments.find(T=>T.comment===e&&!p.value.find(de=>de.id===T.id));U?(p.value.push(U),setTimeout(()=>{const T=document.querySelector("[data-comments-container]");T&&(T.scrollTop=T.scrollHeight)},100)):w.comments.length>p.value.length&&(p.value=[...w.comments])}g.reset(),v.fire({toast:!0,position:"top-end",icon:"success",title:"Comment added",showConfirmButton:!1,timer:2e3,timerProgressBar:!0})},onError:R=>{console.error("Error adding comment:",R)}})}let A=null;return fe(()=>{if(!window.Echo){console.warn("Laravel Echo not initialized. Real-time updates will not work.");return}try{const r=`order.${f.order.id}`;console.log("ðŸ“¡ Subscribing to channel:",r),A=window.Echo.channel(r),A?console.log("âœ… Channel object created:",r):console.error("âŒ Failed to create channel:",r),A.listen(".order.updated",e=>{if(console.log("ðŸ”„ Received order.updated event:",e),e.order){const o=t.value.status;t.value.status=e.order.status,t.value.rejection_reason=e.order.rejection_reason,t.value.approved_at=e.order.approved_at,t.value.updated_at=e.order.updated_at,e.order.approved_by&&(t.value.approved_by={id:e.order.approved_by.id,name:e.order.approved_by.name}),e.order.invoice&&(t.value.invoice={id:e.order.invoice.id,reference_number:e.order.invoice.reference_number}),e.order.status!==o&&v.fire({toast:!0,position:"top-end",icon:"info",title:`Order ${e.order.status}`,text:`Order ${t.value.reference_number} has been ${e.order.status}`,showConfirmButton:!1,timer:3e3,timerProgressBar:!0})}}),A.listen(".comment.added",e=>{var o;console.log("ðŸ”” Received comment.added event:",e),e.comment&&!p.value.find(_=>_.id===e.comment.id)?(console.log("Adding new comment to list:",e.comment),p.value.push(e.comment),p.value.sort((_,R)=>new Date(_.created_at).getTime()-new Date(R.created_at).getTime()),setTimeout(()=>{const _=document.querySelector("[data-comments-container]");_&&(_.scrollTop=_.scrollHeight)},100)):console.log("Comment already exists, skipping:",(o=e.comment)==null?void 0:o.id)}),A.listen("OrderCommentAdded",e=>{console.log("ðŸ”” Received OrderCommentAdded event:",e),e.comment&&!p.value.find(o=>o.id===e.comment.id)&&(console.log("Adding new comment to list:",e.comment),p.value.push(e.comment),p.value.sort((o,_)=>new Date(o.created_at).getTime()-new Date(_.created_at).getTime()),setTimeout(()=>{const o=document.querySelector("[data-comments-container]");o&&(o.scrollTop=o.scrollHeight)},100))})}catch(r){console.error("Error setting up Echo channel:",r)}}),_e(()=>{A&&window.Echo&&window.Echo.leave(`order.${f.order.id}`)}),(r,e)=>(l(),y(xe,{breadcrumbs:ee},{default:n(()=>[a(u(ve),{title:`Order ${t.value.reference_number}`},null,8,["title"]),s("div",be,[s("h1",we,"Order "+i(t.value.reference_number),1),s("div",ke,[a(u(z),{href:r.route("orders.index")},{default:n(()=>[a(u(k),{variant:"ghost"},{default:n(()=>e[4]||(e[4]=[d("Back to Orders")])),_:1,__:[4]})]),_:1},8,["href"]),ie.value?(l(),y(u(k),{key:0,variant:"outline",onClick:ne},{default:n(()=>e[5]||(e[5]=[d(" Cancel Order ")])),_:1,__:[5]})):m("",!0),ae.value?(l(),y(u(k),{key:1,variant:"outline",onClick:e[0]||(e[0]=o=>O.value=!0)},{default:n(()=>e[6]||(e[6]=[d(" Reject Order ")])),_:1,__:[6]})):m("",!0),u(x)&&t.value.status==="pending"?(l(),y(u(k),{key:2,variant:"default",disabled:q.value,onClick:re,title:q.value?"Cannot approve order due to insufficient stock. Please communicate with customer or adjust quantities.":""},{default:n(()=>e[7]||(e[7]=[d(" Approve Order ")])),_:1,__:[7]},8,["disabled","title"])):m("",!0)])]),s("div",Ce,[s("span",{class:W(["px-3 py-1 rounded-full text-sm font-medium",te(t.value.status)])},i(t.value.status.charAt(0).toUpperCase()+t.value.status.slice(1)),3),u(x)&&q.value&&t.value.status==="pending"?(l(),c("div",je,e[8]||(e[8]=[s("p",{class:"text-sm text-red-800"},[s("strong",null,"âš ï¸ Warning:"),d(" This order has insufficient stock. Please communicate with the customer using the comments section below before approving. ")],-1)]))):m("",!0)]),s("div",Be,[s("div",Se,[a(C,null,{default:n(()=>[a(B,null,{default:n(()=>[a(S,null,{default:n(()=>e[9]||(e[9]=[d("Customer Information")])),_:1,__:[9]})]),_:1}),a(j,null,{default:n(()=>[s("div",Ae,[a(ge,{class:"h-16 w-16"},{default:n(()=>[E(t.value.customer)?(l(),y(ye,{key:0,src:E(t.value.customer),alt:t.value.customer.name},null,8,["src","alt"])):(l(),y(he,{key:1},{default:n(()=>[d(i(se(t.value.customer)),1)]),_:1}))]),_:1}),s("div",Te,[s("h3",Re,i(t.value.customer.name),1),t.value.customer.company_name?(l(),c("p",$e,i(t.value.customer.company_name),1)):m("",!0),s("p",Oe,i(t.value.customer.email),1),t.value.customer.phone?(l(),c("p",Pe,i(t.value.customer.phone),1)):m("",!0),N(t.value.customer)?(l(),c("p",qe,i(N(t.value.customer)),1)):m("",!0)])])]),_:1})]),_:1}),t.value.notes?(l(),y(C,{key:0},{default:n(()=>[a(B,null,{default:n(()=>[a(S,null,{default:n(()=>e[10]||(e[10]=[d("Notes")])),_:1,__:[10]})]),_:1}),a(j,null,{default:n(()=>[s("p",De,i(t.value.notes),1)]),_:1})]),_:1})):m("",!0),a(C,null,{default:n(()=>[a(B,null,{default:n(()=>[a(S,null,{default:n(()=>e[11]||(e[11]=[d("Order Items")])),_:1,__:[11]})]),_:1}),a(j,null,{default:n(()=>[s("div",Ie,[(l(!0),c(L,null,M(t.value.order_items,o=>(l(),c("div",{key:o.id,class:"border rounded-md p-4"},[s("div",Ee,[s("div",Ne,[s("h4",Ve,i(o.product.name),1),s("p",Fe,"Quantity: "+i(o.quantity),1),u(x)?(l(),c("p",Ue,"Stock Available: "+i(o.product.stock),1)):m("",!0),u(x)&&o.quantity>o.product.stock?(l(),c("p",He," âš ï¸ Insufficient stock! (Requested: "+i(o.quantity)+", Available: "+i(o.product.stock)+") ",1)):m("",!0)]),s("div",ze,[s("p",We,i(P(o.price))+" each",1),s("p",Le,"Total: "+i(P(o.total)),1)])])]))),128))]),s("div",Me,[s("div",Ye,[s("div",Ge,[t.value.vat_rate>0?(l(),c("div",Qe,"VAT ("+i(t.value.vat_rate)+"%): "+i(P(le.value)),1)):m("",!0),s("div",Je,"Total: "+i(P(t.value.total_amount)),1)])])])]),_:1})]),_:1}),t.value.status==="rejected"&&t.value.rejection_reason?(l(),y(C,{key:1},{default:n(()=>[a(B,null,{default:n(()=>[a(S,{class:"text-red-600"},{default:n(()=>e[12]||(e[12]=[d("Rejection Reason")])),_:1,__:[12]})]),_:1}),a(j,null,{default:n(()=>[s("p",Ke,i(t.value.rejection_reason),1)]),_:1})]),_:1})):m("",!0)]),s("div",Xe,[a(C,null,{default:n(()=>[a(B,null,{default:n(()=>[a(S,null,{default:n(()=>e[13]||(e[13]=[d("Order Information")])),_:1,__:[13]})]),_:1}),a(j,{class:"space-y-3"},{default:n(()=>[s("div",null,[e[14]||(e[14]=s("p",{class:"text-sm text-gray-600"},"Reference Number",-1)),s("p",Ze,i(t.value.reference_number),1)]),s("div",null,[e[15]||(e[15]=s("p",{class:"text-sm text-gray-600"},"Delivery Type",-1)),s("p",et,i(t.value.delivery_type),1)]),s("div",null,[e[16]||(e[16]=s("p",{class:"text-sm text-gray-600"},"Created At",-1)),s("p",tt,i(D(t.value.created_at)),1)]),t.value.approved_at?(l(),c("div",st,[e[17]||(e[17]=s("p",{class:"text-sm text-gray-600"},"Approved At",-1)),s("p",rt,i(D(t.value.approved_at)),1)])):m("",!0),t.value.approved_by?(l(),c("div",ot,[e[18]||(e[18]=s("p",{class:"text-sm text-gray-600"},"Approved By",-1)),s("p",nt,i(t.value.approved_by.name),1)])):m("",!0),t.value.invoice?(l(),c("div",at,[e[19]||(e[19]=s("p",{class:"text-sm text-gray-600"},"Invoice",-1)),a(u(z),{href:r.route("invoices.show",t.value.invoice.id),class:"font-medium text-blue-600 hover:underline"},{default:n(()=>[d(i(t.value.invoice.reference_number),1)]),_:1},8,["href"])])):m("",!0)]),_:1})]),_:1}),a(C,null,{default:n(()=>[a(B,null,{default:n(()=>[a(S,null,{default:n(()=>e[20]||(e[20]=[d("Comments")])),_:1,__:[20]})]),_:1}),a(j,null,{default:n(()=>[p.value.length>0?(l(),c("div",it,[(l(!0),c(L,null,M(p.value,o=>(l(),c("div",{key:o.id,class:W(["border rounded-md p-3",o.is_staff_comment?"bg-blue-50 border-blue-200":"bg-gray-50 border-gray-200"])},[s("div",lt,[s("div",null,[s("p",ut,[d(i(o.user.name)+" ",1),o.is_staff_comment?(l(),c("span",dt,"(Staff)")):(l(),c("span",ct,"(Customer)"))]),s("p",mt,i(D(o.created_at)),1)])]),s("p",pt,i(o.comment),1)],2))),128))])):(l(),c("div",ft," No comments yet. Start the conversation below. ")),s("form",{onSubmit:Y(ue,["prevent"]),class:"space-y-3"},[s("div",null,[a(K,{for:"comment",class:"text-sm"},{default:n(()=>e[21]||(e[21]=[d("Add a comment")])),_:1,__:[21]}),G(s("textarea",{id:"comment","onUpdate:modelValue":e[1]||(e[1]=o=>u(g).comment=o),class:"w-full rounded-md border border-input bg-transparent px-3 py-2 mt-1 text-sm text-foreground dark:bg-input/30 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] focus-visible:outline-none",rows:"3",placeholder:"Type your message here...",required:""},null,512),[[Q,u(g).comment]])]),s("div",_t,[a(u(k),{type:"submit",variant:"default",size:"sm",disabled:u(g).processing},{default:n(()=>[d(i(u(g).processing?"Posting...":"Post Comment"),1)]),_:1},8,["disabled"])])],32)]),_:1})]),_:1})])]),O.value?(l(),c("div",vt,[a(C,{class:"w-full max-w-md mx-4"},{default:n(()=>[a(B,null,{default:n(()=>[a(S,null,{default:n(()=>e[22]||(e[22]=[d("Reject Order")])),_:1,__:[22]})]),_:1}),a(j,null,{default:n(()=>[s("form",{onSubmit:Y(oe,["prevent"]),class:"space-y-4"},[s("div",null,[a(K,{for:"rejection_reason"},{default:n(()=>e[23]||(e[23]=[d("Rejection Reason *")])),_:1,__:[23]}),G(s("textarea",{id:"rejection_reason","onUpdate:modelValue":e[2]||(e[2]=o=>u(b).rejection_reason=o),class:"w-full rounded-md border border-input bg-transparent px-3 py-2 mt-1 text-foreground dark:bg-input/30 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] focus-visible:outline-none",rows:"4",placeholder:"Please provide a reason for rejecting this order...",required:""},null,512),[[Q,u(b).rejection_reason]])]),s("div",gt,[a(u(k),{type:"button",variant:"ghost",onClick:e[3]||(e[3]=o=>{O.value=!1,u(b).reset()})},{default:n(()=>e[24]||(e[24]=[d(" Cancel ")])),_:1,__:[24]}),a(u(k),{type:"submit",variant:"default",disabled:u(b).processing},{default:n(()=>e[25]||(e[25]=[d(" Reject Order ")])),_:1,__:[25]},8,["disabled"])])],32)]),_:1})]),_:1})])):m("",!0)]),_:1}))}});export{It as default};
