import{d as le,G as de,j as F,D as U,z as ue,l as $,m as ce,R as me,c as v,o as a,w as s,a as n,b as r,f as u,h as f,u as l,g as fe,t as i,S as V,e as d,x as z,F as H,r as W,q as L,A as M,B as Y,W as G}from"./app-D8GMqoQL.js";import{_ as w}from"./index-CKTUUg4B.js";import{v as pe,w as _e,x as ge,_ as ve}from"./AppLayout.vue_vue_type_script_setup_true_lang-B7FY6UE4.js";import{_ as C,a as k}from"./CardContent.vue_vue_type_script_setup_true_lang-zCpbmRui.js";import{_ as j,a as S}from"./CardTitle.vue_vue_type_script_setup_true_lang-COI8iZOX.js";import{_ as Q}from"./Label.vue_vue_type_script_setup_true_lang-Dc3JaC7p.js";import{S as _}from"./sweetalert2.esm.all-BQIkj5Wb.js";import"./LocationInput.vue_vue_type_style_index_0_scoped_0fe2f881_lang-Ay1pUOAN.js";import"./RovingFocusGroup-B0Y8hFFN.js";import"./DropdownMenuTrigger.vue_vue_type_script_setup_true_lang-DtVqRXXk.js";import"./createLucideIcon-sEmkw9Pt.js";import"./VisuallyHidden-DKr5urU_.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-BH_Bl99z.js";import"./chevron-right-CmK6lVL2.js";const ye={class:"flex items-center justify-between mb-6"},he={class:"text-2xl font-bold"},be={class:"flex gap-2"},xe={class:"mb-6 flex items-center gap-4"},we={key:0,class:"bg-red-50 border border-red-200 rounded-md px-4 py-2"},Ce={class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},ke={class:"lg:col-span-2 space-y-6"},je={class:"flex items-start gap-4"},Se={class:"flex-1"},Be={class:"text-lg font-semibold"},Te={key:0,class:"text-sm text-gray-600"},Ae={class:"text-sm text-gray-600 mt-1"},Re={key:1,class:"text-sm text-gray-600"},Oe={key:2,class:"text-sm text-gray-600 mt-2"},Pe={class:"space-y-4"},$e={class:"flex justify-between items-start"},qe={class:"flex-1"},De={class:"font-medium"},Ie={class:"text-sm text-gray-600"},Ee={key:0,class:"text-sm text-gray-600"},Ne={key:1,class:"text-sm text-red-600 font-medium mt-1"},Fe={class:"text-right"},Ue={class:"font-medium"},Ve={class:"text-sm text-gray-600"},ze={class:"mt-6 pt-4 border-t"},He={class:"flex justify-end"},We={class:"text-right space-y-1"},Le={class:"text-sm text-gray-600"},Me={class:"text-sm text-gray-600"},Ye={class:"text-lg font-semibold"},Ge={class:"text-sm whitespace-pre-wrap"},Qe={class:"text-sm text-red-600 whitespace-pre-wrap"},Je={class:"space-y-6"},Ke={class:"font-medium"},Xe={class:"font-medium"},Ze={key:0},et={class:"font-medium"},tt={key:1},rt={class:"font-medium"},ot={key:2},st={key:0,class:"space-y-4 mb-6 max-h-[400px] overflow-y-auto","data-comments-container":""},nt={class:"flex items-start justify-between mb-2"},it={class:"font-medium text-sm"},at={key:0,class:"text-xs text-blue-600 ml-2"},lt={key:1,class:"text-xs text-gray-600 ml-2"},dt={class:"text-xs text-gray-500"},ut={class:"text-sm whitespace-pre-wrap mt-2"},ct={key:1,class:"text-sm text-gray-500 mb-6 text-center py-4"},mt={class:"flex justify-end"},ft={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},pt={class:"flex gap-2 justify-end"},At=le({__name:"Show",props:{order:{},hasStockIssues:{type:Boolean}},setup(J){var I,E;const c=J,y=de(),K=Array.isArray((I=y.props.auth)==null?void 0:I.userRoles)&&y.props.auth.userRoles.includes("Customer"),h=Array.isArray((E=y.props.auth)==null?void 0:E.userRoles)&&(y.props.auth.userRoles.includes("Admin")||y.props.auth.userRoles.includes("Staff")),O=F(!1),b=U({rejection_reason:""}),g=U({comment:""}),m=F([...c.order.comments||[]]);ue(()=>c.order.comments,t=>{t&&Array.isArray(t)&&(t.forEach(e=>{m.value.find(o=>o.id===e.id)||m.value.push(e)}),m.value.sort((e,o)=>new Date(e.created_at).getTime()-new Date(o.created_at).getTime()))},{deep:!0});const X=[{title:"Orders",href:"/orders"},{title:c.order.reference_number,href:`/orders/${c.order.id}`}];function Z(t){switch(t){case"pending":return"bg-yellow-100 text-yellow-800";case"approved":return"bg-green-100 text-green-800";case"rejected":return"bg-red-100 text-red-800";case"cancelled":return"bg-gray-100 text-gray-800";default:return"bg-gray-100 text-gray-800"}}function T(t){return new Intl.NumberFormat("en-PH",{style:"currency",currency:"PHP",minimumFractionDigits:2}).format(t)}function q(t){return new Date(t).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}function D(t){if(!t.media||t.media.length===0)return null;const e=t.media.find(o=>o.mime_type&&o.mime_type.startsWith("image/"));return e?e.thumb_url||e.original_url:null}function ee(t){return t.name.split(" ").map(e=>e.charAt(0)).join("").toUpperCase().slice(0,2)}function te(){_.fire({title:"Approve this order?",text:"This will check product availability, deduct stock, and create an invoice.",icon:"question",showCancelButton:!0,confirmButtonColor:"#10b981",cancelButtonColor:"#6b7280",confirmButtonText:"Yes, approve",cancelButtonText:"Cancel"}).then(t=>{t.isConfirmed&&G.post(route("orders.approve",c.order.id),{},{preserveScroll:!0,onSuccess:()=>{_.fire({toast:!0,position:"top-end",icon:"success",title:"Order approved",text:"Invoice has been created successfully.",showConfirmButton:!1,timer:3e3,timerProgressBar:!0})},onError:e=>{_.fire({icon:"error",title:"Approval failed",text:e.stock||"Unable to approve order. Please check product availability."})}})})}function re(){if(!b.rejection_reason.trim()){_.fire({icon:"warning",title:"Rejection reason required",text:"Please provide a reason for rejecting this order."});return}_.fire({title:"Reject this order?",text:"This action cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#ef4444",cancelButtonColor:"#6b7280",confirmButtonText:"Yes, reject",cancelButtonText:"Cancel"}).then(t=>{t.isConfirmed&&b.post(route("orders.reject",c.order.id),{preserveScroll:!0,onSuccess:()=>{O.value=!1,b.reset(),_.fire({toast:!0,position:"top-end",icon:"success",title:"Order rejected",showConfirmButton:!1,timer:3e3,timerProgressBar:!0})}})})}function oe(){_.fire({title:"Cancel this order?",text:"This action cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#ef4444",cancelButtonColor:"#6b7280",confirmButtonText:"Yes, cancel",cancelButtonText:"No"}).then(t=>{t.isConfirmed&&G.post(route("orders.cancel",c.order.id),{},{preserveScroll:!0,onSuccess:()=>{_.fire({toast:!0,position:"top-end",icon:"success",title:"Order cancelled",showConfirmButton:!1,timer:3e3,timerProgressBar:!0})}})})}const P=$(()=>c.hasStockIssues!==void 0?c.hasStockIssues:c.order.order_items.some(t=>t.quantity>t.product.stock));$(()=>h&&c.order.status==="pending"&&!P.value);const se=$(()=>h&&c.order.status==="pending"),ne=$(()=>(K||h)&&c.order.status==="pending");function ie(){var o,p;if(!g.comment.trim()){_.fire({icon:"warning",title:"Comment required",text:"Please enter a comment."});return}(o=y.props.auth)==null||o.user;const t=((p=y.props.auth)==null?void 0:p.userRoles)||[];t.includes("Admin")||t.includes("Staff");const e=g.comment;g.post(route("orders.comments.store",c.order.id),{preserveScroll:!0,onSuccess:R=>{const x=R.props.order;if(x!=null&&x.comments&&Array.isArray(x.comments)){const N=x.comments.find(B=>B.comment===e&&!m.value.find(ae=>ae.id===B.id));N?(m.value.push(N),setTimeout(()=>{const B=document.querySelector("[data-comments-container]");B&&(B.scrollTop=B.scrollHeight)},100)):x.comments.length>m.value.length&&(m.value=[...x.comments])}g.reset(),_.fire({toast:!0,position:"top-end",icon:"success",title:"Comment added",showConfirmButton:!1,timer:2e3,timerProgressBar:!0})},onError:R=>{console.error("Error adding comment:",R)}})}let A=null;return ce(()=>{if(!window.Echo){console.warn("Laravel Echo not initialized. Real-time updates will not work.");return}try{const t=`order.${c.order.id}`;console.log("ðŸ“¡ Subscribing to channel:",t),A=window.Echo.channel(t),A?console.log("âœ… Channel object created:",t):console.error("âŒ Failed to create channel:",t),A.listen(".comment.added",e=>{var o;console.log("ðŸ”” Received comment.added event:",e),e.comment&&!m.value.find(p=>p.id===e.comment.id)?(console.log("Adding new comment to list:",e.comment),m.value.push(e.comment),m.value.sort((p,R)=>new Date(p.created_at).getTime()-new Date(R.created_at).getTime()),setTimeout(()=>{const p=document.querySelector("[data-comments-container]");p&&(p.scrollTop=p.scrollHeight)},100)):console.log("Comment already exists, skipping:",(o=e.comment)==null?void 0:o.id)}),A.listen("OrderCommentAdded",e=>{console.log("ðŸ”” Received OrderCommentAdded event:",e),e.comment&&!m.value.find(o=>o.id===e.comment.id)&&(console.log("Adding new comment to list:",e.comment),m.value.push(e.comment),m.value.sort((o,p)=>new Date(o.created_at).getTime()-new Date(p.created_at).getTime()),setTimeout(()=>{const o=document.querySelector("[data-comments-container]");o&&(o.scrollTop=o.scrollHeight)},100))})}catch(t){console.error("Error setting up Echo channel:",t)}}),me(()=>{A&&window.Echo&&window.Echo.leave(`order.${c.order.id}`)}),(t,e)=>(a(),v(ve,{breadcrumbs:X},{default:s(()=>[n(l(fe),{title:`Order ${t.order.reference_number}`},null,8,["title"]),r("div",ye,[r("h1",he,"Order "+i(t.order.reference_number),1),r("div",be,[n(l(V),{href:t.route("orders.index")},{default:s(()=>[n(l(w),{variant:"ghost"},{default:s(()=>e[4]||(e[4]=[d("Back to Orders")])),_:1,__:[4]})]),_:1},8,["href"]),ne.value?(a(),v(l(w),{key:0,variant:"outline",onClick:oe},{default:s(()=>e[5]||(e[5]=[d(" Cancel Order ")])),_:1,__:[5]})):f("",!0),se.value?(a(),v(l(w),{key:1,variant:"outline",onClick:e[0]||(e[0]=o=>O.value=!0)},{default:s(()=>e[6]||(e[6]=[d(" Reject Order ")])),_:1,__:[6]})):f("",!0),l(h)&&t.order.status==="pending"?(a(),v(l(w),{key:2,variant:"default",disabled:P.value,onClick:te,title:P.value?"Cannot approve order due to insufficient stock. Please communicate with customer or adjust quantities.":""},{default:s(()=>e[7]||(e[7]=[d(" Approve Order ")])),_:1,__:[7]},8,["disabled","title"])):f("",!0)])]),r("div",xe,[r("span",{class:z(["px-3 py-1 rounded-full text-sm font-medium",Z(t.order.status)])},i(t.order.status.charAt(0).toUpperCase()+t.order.status.slice(1)),3),l(h)&&P.value&&t.order.status==="pending"?(a(),u("div",we,e[8]||(e[8]=[r("p",{class:"text-sm text-red-800"},[r("strong",null,"âš ï¸ Warning:"),d(" This order has insufficient stock. Please communicate with the customer using the comments section below before approving. ")],-1)]))):f("",!0)]),r("div",Ce,[r("div",ke,[n(C,null,{default:s(()=>[n(j,null,{default:s(()=>[n(S,null,{default:s(()=>e[9]||(e[9]=[d("Customer Information")])),_:1,__:[9]})]),_:1}),n(k,null,{default:s(()=>[r("div",je,[n(pe,{class:"h-16 w-16"},{default:s(()=>[D(t.order.customer)?(a(),v(_e,{key:0,src:D(t.order.customer),alt:t.order.customer.name},null,8,["src","alt"])):(a(),v(ge,{key:1},{default:s(()=>[d(i(ee(t.order.customer)),1)]),_:1}))]),_:1}),r("div",Se,[r("h3",Be,i(t.order.customer.name),1),t.order.customer.company_name?(a(),u("p",Te,i(t.order.customer.company_name),1)):f("",!0),r("p",Ae,i(t.order.customer.email),1),t.order.customer.phone?(a(),u("p",Re,i(t.order.customer.phone),1)):f("",!0),t.order.customer.address?(a(),u("p",Oe,i(t.order.customer.address),1)):f("",!0)])])]),_:1})]),_:1}),n(C,null,{default:s(()=>[n(j,null,{default:s(()=>[n(S,null,{default:s(()=>e[10]||(e[10]=[d("Order Items")])),_:1,__:[10]})]),_:1}),n(k,null,{default:s(()=>[r("div",Pe,[(a(!0),u(H,null,W(t.order.order_items,o=>(a(),u("div",{key:o.id,class:"border rounded-md p-4"},[r("div",$e,[r("div",qe,[r("h4",De,i(o.product.name),1),r("p",Ie,"Quantity: "+i(o.quantity),1),l(h)?(a(),u("p",Ee,"Stock Available: "+i(o.product.stock),1)):f("",!0),l(h)&&o.quantity>o.product.stock?(a(),u("p",Ne," âš ï¸ Insufficient stock! (Requested: "+i(o.quantity)+", Available: "+i(o.product.stock)+") ",1)):f("",!0)]),r("div",Fe,[r("p",Ue,i(T(o.price))+" each",1),r("p",Ve,"Total: "+i(T(o.total)),1)])])]))),128))]),r("div",ze,[r("div",He,[r("div",We,[r("div",Le,"Subtotal: "+i(T(t.order.subtotal_amount)),1),r("div",Me,"VAT ("+i(t.order.vat_rate)+"%): "+i(T(t.order.vat_amount)),1),r("div",Ye,"Total: "+i(T(t.order.total_amount)),1)])])])]),_:1})]),_:1}),t.order.notes?(a(),v(C,{key:0},{default:s(()=>[n(j,null,{default:s(()=>[n(S,null,{default:s(()=>e[11]||(e[11]=[d("Notes")])),_:1,__:[11]})]),_:1}),n(k,null,{default:s(()=>[r("p",Ge,i(t.order.notes),1)]),_:1})]),_:1})):f("",!0),t.order.status==="rejected"&&t.order.rejection_reason?(a(),v(C,{key:1},{default:s(()=>[n(j,null,{default:s(()=>[n(S,{class:"text-red-600"},{default:s(()=>e[12]||(e[12]=[d("Rejection Reason")])),_:1,__:[12]})]),_:1}),n(k,null,{default:s(()=>[r("p",Qe,i(t.order.rejection_reason),1)]),_:1})]),_:1})):f("",!0)]),r("div",Je,[n(C,null,{default:s(()=>[n(j,null,{default:s(()=>[n(S,null,{default:s(()=>e[13]||(e[13]=[d("Order Information")])),_:1,__:[13]})]),_:1}),n(k,{class:"space-y-3"},{default:s(()=>[r("div",null,[e[14]||(e[14]=r("p",{class:"text-sm text-gray-600"},"Reference Number",-1)),r("p",Ke,i(t.order.reference_number),1)]),r("div",null,[e[15]||(e[15]=r("p",{class:"text-sm text-gray-600"},"Created At",-1)),r("p",Xe,i(q(t.order.created_at)),1)]),t.order.approved_at?(a(),u("div",Ze,[e[16]||(e[16]=r("p",{class:"text-sm text-gray-600"},"Approved At",-1)),r("p",et,i(q(t.order.approved_at)),1)])):f("",!0),t.order.approved_by?(a(),u("div",tt,[e[17]||(e[17]=r("p",{class:"text-sm text-gray-600"},"Approved By",-1)),r("p",rt,i(t.order.approved_by.name),1)])):f("",!0),t.order.invoice?(a(),u("div",ot,[e[18]||(e[18]=r("p",{class:"text-sm text-gray-600"},"Invoice",-1)),n(l(V),{href:t.route("invoices.show",t.order.invoice.id),class:"font-medium text-blue-600 hover:underline"},{default:s(()=>[d(i(t.order.invoice.reference_number),1)]),_:1},8,["href"])])):f("",!0)]),_:1})]),_:1}),n(C,null,{default:s(()=>[n(j,null,{default:s(()=>[n(S,null,{default:s(()=>e[19]||(e[19]=[d("Comments")])),_:1,__:[19]})]),_:1}),n(k,null,{default:s(()=>[m.value.length>0?(a(),u("div",st,[(a(!0),u(H,null,W(m.value,o=>(a(),u("div",{key:o.id,class:z(["border rounded-md p-3",o.is_staff_comment?"bg-blue-50 border-blue-200":"bg-gray-50 border-gray-200"])},[r("div",nt,[r("div",null,[r("p",it,[d(i(o.user.name)+" ",1),o.is_staff_comment?(a(),u("span",at,"(Staff)")):(a(),u("span",lt,"(Customer)"))]),r("p",dt,i(q(o.created_at)),1)])]),r("p",ut,i(o.comment),1)],2))),128))])):(a(),u("div",ct," No comments yet. Start the conversation below. ")),r("form",{onSubmit:L(ie,["prevent"]),class:"space-y-3"},[r("div",null,[n(Q,{for:"comment",class:"text-sm"},{default:s(()=>e[20]||(e[20]=[d("Add a comment")])),_:1,__:[20]}),M(r("textarea",{id:"comment","onUpdate:modelValue":e[1]||(e[1]=o=>l(g).comment=o),class:"w-full rounded-md border border-input bg-transparent px-3 py-2 mt-1 text-sm text-foreground dark:bg-input/30 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] focus-visible:outline-none",rows:"3",placeholder:"Type your message here...",required:""},null,512),[[Y,l(g).comment]])]),r("div",mt,[n(l(w),{type:"submit",variant:"default",size:"sm",disabled:l(g).processing},{default:s(()=>[d(i(l(g).processing?"Posting...":"Post Comment"),1)]),_:1},8,["disabled"])])],32)]),_:1})]),_:1})])]),O.value?(a(),u("div",ft,[n(C,{class:"w-full max-w-md mx-4"},{default:s(()=>[n(j,null,{default:s(()=>[n(S,null,{default:s(()=>e[21]||(e[21]=[d("Reject Order")])),_:1,__:[21]})]),_:1}),n(k,null,{default:s(()=>[r("form",{onSubmit:L(re,["prevent"]),class:"space-y-4"},[r("div",null,[n(Q,{for:"rejection_reason"},{default:s(()=>e[22]||(e[22]=[d("Rejection Reason *")])),_:1,__:[22]}),M(r("textarea",{id:"rejection_reason","onUpdate:modelValue":e[2]||(e[2]=o=>l(b).rejection_reason=o),class:"w-full rounded-md border border-input bg-transparent px-3 py-2 mt-1 text-foreground dark:bg-input/30 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] focus-visible:outline-none",rows:"4",placeholder:"Please provide a reason for rejecting this order...",required:""},null,512),[[Y,l(b).rejection_reason]])]),r("div",pt,[n(l(w),{type:"button",variant:"ghost",onClick:e[3]||(e[3]=o=>{O.value=!1,l(b).reset()})},{default:s(()=>e[23]||(e[23]=[d(" Cancel ")])),_:1,__:[23]}),n(l(w),{type:"submit",variant:"default",disabled:l(b).processing},{default:s(()=>e[24]||(e[24]=[d(" Reject Order ")])),_:1,__:[24]},8,["disabled"])])],32)]),_:1})]),_:1})])):f("",!0)]),_:1}))}});export{At as default};
