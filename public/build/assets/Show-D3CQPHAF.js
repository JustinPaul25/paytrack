import{d as ue,v as de,m as I,D as V,s as ce,p as q,q as me,A as fe,c as y,o as l,w as r,a,b as t,f as c,h as f,u,g as pe,t as i,S as z,e as d,l as H,F as W,r as L,E as M,x as Y,y as Q,W as G}from"./app-1A5YSak6.js";import{_ as C}from"./index-BWU88cBJ.js";import{p as _e,q as ve,r as ge,_ as ye}from"./AppLayout.vue_vue_type_script_setup_true_lang-BCVanqXE.js";import{_ as k,a as j}from"./CardContent.vue_vue_type_script_setup_true_lang-DYhZIIS0.js";import{_ as S,a as B}from"./CardTitle.vue_vue_type_script_setup_true_lang-C4ol0moP.js";import{_ as J}from"./Label.vue_vue_type_script_setup_true_lang-B3Uu3sDk.js";import{S as v}from"./sweetalert2.esm.all-BQIkj5Wb.js";import"./LocationInput.vue_vue_type_style_index_0_scoped_0fe2f881_lang-BHJz_n_j.js";import"./useForwardPropsEmits-DLwOjtLV.js";import"./DropdownMenuTrigger.vue_vue_type_script_setup_true_lang-CY5h4SiE.js";import"./createLucideIcon-BqpLk_z0.js";import"./Teleport-BHg1vLCi.js";import"./RovingFocusGroup-hZDTo2Q6.js";import"./VisuallyHidden-B3oxVUhX.js";import"./x-CQ3Uca_e.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-D1Pjj9RT.js";const xe={class:"flex items-center justify-between mb-6"},he={class:"text-2xl font-bold"},be={class:"flex gap-2"},we={class:"mb-6 flex items-center gap-4"},Ce={key:0,class:"bg-red-50 border border-red-200 rounded-md px-4 py-2"},ke={class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},je={class:"lg:col-span-2 space-y-6"},Se={class:"flex items-start gap-4"},Be={class:"flex-1"},Te={class:"text-lg font-semibold"},Ae={key:0,class:"text-sm text-gray-600"},Re={class:"text-sm text-gray-600 mt-1"},Oe={key:1,class:"text-sm text-gray-600"},$e={key:2,class:"text-sm text-gray-600 mt-2"},Pe={class:"space-y-4"},qe={class:"flex justify-between items-start"},De={class:"flex-1"},Ie={class:"font-medium"},Ee={class:"text-sm text-gray-600"},Ne={key:0,class:"text-sm text-gray-600"},Fe={key:1,class:"text-sm text-red-600 font-medium mt-1"},Ue={class:"text-right"},Ve={class:"font-medium"},ze={class:"text-sm text-gray-600"},He={class:"mt-6 pt-4 border-t"},We={class:"flex justify-end"},Le={class:"text-right space-y-1"},Me={class:"text-sm text-gray-600"},Ye={class:"text-sm text-gray-600"},Qe={class:"text-lg font-semibold"},Ge={class:"text-sm whitespace-pre-wrap"},Je={class:"text-sm text-red-600 whitespace-pre-wrap"},Ke={class:"space-y-6"},Xe={class:"font-medium"},Ze={class:"font-medium capitalize"},et={class:"font-medium"},tt={key:0},st={class:"font-medium"},ot={key:1},rt={class:"font-medium"},nt={key:2},at={key:0,class:"space-y-4 mb-6 max-h-[400px] overflow-y-auto","data-comments-container":""},it={class:"flex items-start justify-between mb-2"},lt={class:"font-medium text-sm"},ut={key:0,class:"text-xs text-blue-600 ml-2"},dt={key:1,class:"text-xs text-gray-600 ml-2"},ct={class:"text-xs text-gray-500"},mt={class:"text-sm whitespace-pre-wrap mt-2"},ft={key:1,class:"text-sm text-gray-500 mb-6 text-center py-4"},pt={class:"flex justify-end"},_t={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},vt={class:"flex gap-2 justify-end"},Pt=ue({__name:"Show",props:{order:{},hasStockIssues:{type:Boolean}},setup(K){var N,F;const p=K,x=de(),X=Array.isArray((N=x.props.auth)==null?void 0:N.userRoles)&&x.props.auth.userRoles.includes("Customer"),h=Array.isArray((F=x.props.auth)==null?void 0:F.userRoles)&&(x.props.auth.userRoles.includes("Admin")||x.props.auth.userRoles.includes("Staff")),$=I(!1),b=V({rejection_reason:""}),g=V({comment:""}),m=I([...p.order.comments||[]]),s=I({...p.order});ce(()=>p.order.comments,n=>{n&&Array.isArray(n)&&(n.forEach(e=>{m.value.find(o=>o.id===e.id)||m.value.push(e)}),m.value.sort((e,o)=>new Date(e.created_at).getTime()-new Date(o.created_at).getTime()))},{deep:!0});const Z=[{title:"Orders",href:"/orders"},{title:p.order.reference_number,href:`/orders/${p.order.id}`}];function ee(n){switch(n){case"pending":return"bg-yellow-100 text-yellow-800";case"approved":return"bg-green-100 text-green-800";case"rejected":return"bg-red-100 text-red-800";case"cancelled":return"bg-gray-100 text-gray-800";default:return"bg-gray-100 text-gray-800"}}function R(n){return new Intl.NumberFormat("en-PH",{style:"currency",currency:"PHP",minimumFractionDigits:2}).format(n)}function D(n){return new Date(n).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}function E(n){if(!n.media||n.media.length===0)return null;const e=n.media.find(o=>o.mime_type&&o.mime_type.startsWith("image/"));return e?e.thumb_url||e.original_url:null}function te(n){return n.name.split(" ").map(e=>e.charAt(0)).join("").toUpperCase().slice(0,2)}function se(){v.fire({title:"Approve this order?",text:"This will check product availability, deduct stock, and create an invoice.",icon:"question",showCancelButton:!0,confirmButtonColor:"#10b981",cancelButtonColor:"#6b7280",confirmButtonText:"Yes, approve",cancelButtonText:"Cancel"}).then(n=>{n.isConfirmed&&G.post(route("orders.approve",p.order.id),{},{preserveScroll:!0,onSuccess:()=>{v.fire({toast:!0,position:"top-end",icon:"success",title:"Order approved",text:"Invoice has been created successfully.",showConfirmButton:!1,timer:3e3,timerProgressBar:!0})},onError:e=>{v.fire({icon:"error",title:"Approval failed",text:e.stock||"Unable to approve order. Please check product availability."})}})})}function oe(){if(!b.rejection_reason.trim()){v.fire({icon:"warning",title:"Rejection reason required",text:"Please provide a reason for rejecting this order."});return}v.fire({title:"Reject this order?",text:"This action cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#ef4444",cancelButtonColor:"#6b7280",confirmButtonText:"Yes, reject",cancelButtonText:"Cancel"}).then(n=>{n.isConfirmed&&b.post(route("orders.reject",p.order.id),{preserveScroll:!0,onSuccess:()=>{$.value=!1,b.reset(),v.fire({toast:!0,position:"top-end",icon:"success",title:"Order rejected",showConfirmButton:!1,timer:3e3,timerProgressBar:!0})}})})}function re(){v.fire({title:"Cancel this order?",text:"This action cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#ef4444",cancelButtonColor:"#6b7280",confirmButtonText:"Yes, cancel",cancelButtonText:"No"}).then(n=>{n.isConfirmed&&G.post(route("orders.cancel",p.order.id),{},{preserveScroll:!0,onSuccess:()=>{v.fire({toast:!0,position:"top-end",icon:"success",title:"Order cancelled",showConfirmButton:!1,timer:3e3,timerProgressBar:!0})}})})}const P=q(()=>p.hasStockIssues!==void 0?p.hasStockIssues:s.value.order_items.some(n=>n.quantity>n.product.stock));q(()=>h&&s.value.status==="pending"&&!P.value);const ne=q(()=>h&&s.value.status==="pending"),ae=q(()=>(X||h)&&s.value.status==="pending");function ie(){var o,_;if(!g.comment.trim()){v.fire({icon:"warning",title:"Comment required",text:"Please enter a comment."});return}(o=x.props.auth)==null||o.user;const n=((_=x.props.auth)==null?void 0:_.userRoles)||[];n.includes("Admin")||n.includes("Staff");const e=g.comment;g.post(route("orders.comments.store",p.order.id),{preserveScroll:!0,onSuccess:O=>{const w=O.props.order;if(w!=null&&w.comments&&Array.isArray(w.comments)){const U=w.comments.find(A=>A.comment===e&&!m.value.find(le=>le.id===A.id));U?(m.value.push(U),setTimeout(()=>{const A=document.querySelector("[data-comments-container]");A&&(A.scrollTop=A.scrollHeight)},100)):w.comments.length>m.value.length&&(m.value=[...w.comments])}g.reset(),v.fire({toast:!0,position:"top-end",icon:"success",title:"Comment added",showConfirmButton:!1,timer:2e3,timerProgressBar:!0})},onError:O=>{console.error("Error adding comment:",O)}})}let T=null;return me(()=>{if(!window.Echo){console.warn("Laravel Echo not initialized. Real-time updates will not work.");return}try{const n=`order.${p.order.id}`;console.log("ðŸ“¡ Subscribing to channel:",n),T=window.Echo.channel(n),T?console.log("âœ… Channel object created:",n):console.error("âŒ Failed to create channel:",n),T.listen(".order.updated",e=>{if(console.log("ðŸ”„ Received order.updated event:",e),e.order){const o=s.value.status;s.value.status=e.order.status,s.value.rejection_reason=e.order.rejection_reason,s.value.approved_at=e.order.approved_at,s.value.updated_at=e.order.updated_at,e.order.approved_by&&(s.value.approved_by={id:e.order.approved_by.id,name:e.order.approved_by.name}),e.order.invoice&&(s.value.invoice={id:e.order.invoice.id,reference_number:e.order.invoice.reference_number}),e.order.status!==o&&v.fire({toast:!0,position:"top-end",icon:"info",title:`Order ${e.order.status}`,text:`Order ${s.value.reference_number} has been ${e.order.status}`,showConfirmButton:!1,timer:3e3,timerProgressBar:!0})}}),T.listen(".comment.added",e=>{var o;console.log("ðŸ”” Received comment.added event:",e),e.comment&&!m.value.find(_=>_.id===e.comment.id)?(console.log("Adding new comment to list:",e.comment),m.value.push(e.comment),m.value.sort((_,O)=>new Date(_.created_at).getTime()-new Date(O.created_at).getTime()),setTimeout(()=>{const _=document.querySelector("[data-comments-container]");_&&(_.scrollTop=_.scrollHeight)},100)):console.log("Comment already exists, skipping:",(o=e.comment)==null?void 0:o.id)}),T.listen("OrderCommentAdded",e=>{console.log("ðŸ”” Received OrderCommentAdded event:",e),e.comment&&!m.value.find(o=>o.id===e.comment.id)&&(console.log("Adding new comment to list:",e.comment),m.value.push(e.comment),m.value.sort((o,_)=>new Date(o.created_at).getTime()-new Date(_.created_at).getTime()),setTimeout(()=>{const o=document.querySelector("[data-comments-container]");o&&(o.scrollTop=o.scrollHeight)},100))})}catch(n){console.error("Error setting up Echo channel:",n)}}),fe(()=>{T&&window.Echo&&window.Echo.leave(`order.${p.order.id}`)}),(n,e)=>(l(),y(ye,{breadcrumbs:Z},{default:r(()=>[a(u(pe),{title:`Order ${s.value.reference_number}`},null,8,["title"]),t("div",xe,[t("h1",he,"Order "+i(s.value.reference_number),1),t("div",be,[a(u(z),{href:n.route("orders.index")},{default:r(()=>[a(u(C),{variant:"ghost"},{default:r(()=>e[4]||(e[4]=[d("Back to Orders")])),_:1,__:[4]})]),_:1},8,["href"]),ae.value?(l(),y(u(C),{key:0,variant:"outline",onClick:re},{default:r(()=>e[5]||(e[5]=[d(" Cancel Order ")])),_:1,__:[5]})):f("",!0),ne.value?(l(),y(u(C),{key:1,variant:"outline",onClick:e[0]||(e[0]=o=>$.value=!0)},{default:r(()=>e[6]||(e[6]=[d(" Reject Order ")])),_:1,__:[6]})):f("",!0),u(h)&&s.value.status==="pending"?(l(),y(u(C),{key:2,variant:"default",disabled:P.value,onClick:se,title:P.value?"Cannot approve order due to insufficient stock. Please communicate with customer or adjust quantities.":""},{default:r(()=>e[7]||(e[7]=[d(" Approve Order ")])),_:1,__:[7]},8,["disabled","title"])):f("",!0)])]),t("div",we,[t("span",{class:H(["px-3 py-1 rounded-full text-sm font-medium",ee(s.value.status)])},i(s.value.status.charAt(0).toUpperCase()+s.value.status.slice(1)),3),u(h)&&P.value&&s.value.status==="pending"?(l(),c("div",Ce,e[8]||(e[8]=[t("p",{class:"text-sm text-red-800"},[t("strong",null,"âš ï¸ Warning:"),d(" This order has insufficient stock. Please communicate with the customer using the comments section below before approving. ")],-1)]))):f("",!0)]),t("div",ke,[t("div",je,[a(k,null,{default:r(()=>[a(S,null,{default:r(()=>[a(B,null,{default:r(()=>e[9]||(e[9]=[d("Customer Information")])),_:1,__:[9]})]),_:1}),a(j,null,{default:r(()=>[t("div",Se,[a(_e,{class:"h-16 w-16"},{default:r(()=>[E(s.value.customer)?(l(),y(ve,{key:0,src:E(s.value.customer),alt:s.value.customer.name},null,8,["src","alt"])):(l(),y(ge,{key:1},{default:r(()=>[d(i(te(s.value.customer)),1)]),_:1}))]),_:1}),t("div",Be,[t("h3",Te,i(s.value.customer.name),1),s.value.customer.company_name?(l(),c("p",Ae,i(s.value.customer.company_name),1)):f("",!0),t("p",Re,i(s.value.customer.email),1),s.value.customer.phone?(l(),c("p",Oe,i(s.value.customer.phone),1)):f("",!0),s.value.customer.address?(l(),c("p",$e,i(s.value.customer.address),1)):f("",!0)])])]),_:1})]),_:1}),a(k,null,{default:r(()=>[a(S,null,{default:r(()=>[a(B,null,{default:r(()=>e[10]||(e[10]=[d("Order Items")])),_:1,__:[10]})]),_:1}),a(j,null,{default:r(()=>[t("div",Pe,[(l(!0),c(W,null,L(s.value.order_items,o=>(l(),c("div",{key:o.id,class:"border rounded-md p-4"},[t("div",qe,[t("div",De,[t("h4",Ie,i(o.product.name),1),t("p",Ee,"Quantity: "+i(o.quantity),1),u(h)?(l(),c("p",Ne,"Stock Available: "+i(o.product.stock),1)):f("",!0),u(h)&&o.quantity>o.product.stock?(l(),c("p",Fe," âš ï¸ Insufficient stock! (Requested: "+i(o.quantity)+", Available: "+i(o.product.stock)+") ",1)):f("",!0)]),t("div",Ue,[t("p",Ve,i(R(o.price))+" each",1),t("p",ze,"Total: "+i(R(o.total)),1)])])]))),128))]),t("div",He,[t("div",We,[t("div",Le,[t("div",Me,"Subtotal: "+i(R(s.value.subtotal_amount)),1),t("div",Ye,"VAT ("+i(s.value.vat_rate)+"%): "+i(R(s.value.vat_amount)),1),t("div",Qe,"Total: "+i(R(s.value.total_amount)),1)])])])]),_:1})]),_:1}),s.value.notes?(l(),y(k,{key:0},{default:r(()=>[a(S,null,{default:r(()=>[a(B,null,{default:r(()=>e[11]||(e[11]=[d("Notes")])),_:1,__:[11]})]),_:1}),a(j,null,{default:r(()=>[t("p",Ge,i(s.value.notes),1)]),_:1})]),_:1})):f("",!0),s.value.status==="rejected"&&s.value.rejection_reason?(l(),y(k,{key:1},{default:r(()=>[a(S,null,{default:r(()=>[a(B,{class:"text-red-600"},{default:r(()=>e[12]||(e[12]=[d("Rejection Reason")])),_:1,__:[12]})]),_:1}),a(j,null,{default:r(()=>[t("p",Je,i(s.value.rejection_reason),1)]),_:1})]),_:1})):f("",!0)]),t("div",Ke,[a(k,null,{default:r(()=>[a(S,null,{default:r(()=>[a(B,null,{default:r(()=>e[13]||(e[13]=[d("Order Information")])),_:1,__:[13]})]),_:1}),a(j,{class:"space-y-3"},{default:r(()=>[t("div",null,[e[14]||(e[14]=t("p",{class:"text-sm text-gray-600"},"Reference Number",-1)),t("p",Xe,i(s.value.reference_number),1)]),t("div",null,[e[15]||(e[15]=t("p",{class:"text-sm text-gray-600"},"Delivery Type",-1)),t("p",Ze,i(s.value.delivery_type),1)]),t("div",null,[e[16]||(e[16]=t("p",{class:"text-sm text-gray-600"},"Created At",-1)),t("p",et,i(D(s.value.created_at)),1)]),s.value.approved_at?(l(),c("div",tt,[e[17]||(e[17]=t("p",{class:"text-sm text-gray-600"},"Approved At",-1)),t("p",st,i(D(s.value.approved_at)),1)])):f("",!0),s.value.approved_by?(l(),c("div",ot,[e[18]||(e[18]=t("p",{class:"text-sm text-gray-600"},"Approved By",-1)),t("p",rt,i(s.value.approved_by.name),1)])):f("",!0),s.value.invoice?(l(),c("div",nt,[e[19]||(e[19]=t("p",{class:"text-sm text-gray-600"},"Invoice",-1)),a(u(z),{href:n.route("invoices.show",s.value.invoice.id),class:"font-medium text-blue-600 hover:underline"},{default:r(()=>[d(i(s.value.invoice.reference_number),1)]),_:1},8,["href"])])):f("",!0)]),_:1})]),_:1}),a(k,null,{default:r(()=>[a(S,null,{default:r(()=>[a(B,null,{default:r(()=>e[20]||(e[20]=[d("Comments")])),_:1,__:[20]})]),_:1}),a(j,null,{default:r(()=>[m.value.length>0?(l(),c("div",at,[(l(!0),c(W,null,L(m.value,o=>(l(),c("div",{key:o.id,class:H(["border rounded-md p-3",o.is_staff_comment?"bg-blue-50 border-blue-200":"bg-gray-50 border-gray-200"])},[t("div",it,[t("div",null,[t("p",lt,[d(i(o.user.name)+" ",1),o.is_staff_comment?(l(),c("span",ut,"(Staff)")):(l(),c("span",dt,"(Customer)"))]),t("p",ct,i(D(o.created_at)),1)])]),t("p",mt,i(o.comment),1)],2))),128))])):(l(),c("div",ft," No comments yet. Start the conversation below. ")),t("form",{onSubmit:M(ie,["prevent"]),class:"space-y-3"},[t("div",null,[a(J,{for:"comment",class:"text-sm"},{default:r(()=>e[21]||(e[21]=[d("Add a comment")])),_:1,__:[21]}),Y(t("textarea",{id:"comment","onUpdate:modelValue":e[1]||(e[1]=o=>u(g).comment=o),class:"w-full rounded-md border border-input bg-transparent px-3 py-2 mt-1 text-sm text-foreground dark:bg-input/30 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] focus-visible:outline-none",rows:"3",placeholder:"Type your message here...",required:""},null,512),[[Q,u(g).comment]])]),t("div",pt,[a(u(C),{type:"submit",variant:"default",size:"sm",disabled:u(g).processing},{default:r(()=>[d(i(u(g).processing?"Posting...":"Post Comment"),1)]),_:1},8,["disabled"])])],32)]),_:1})]),_:1})])]),$.value?(l(),c("div",_t,[a(k,{class:"w-full max-w-md mx-4"},{default:r(()=>[a(S,null,{default:r(()=>[a(B,null,{default:r(()=>e[22]||(e[22]=[d("Reject Order")])),_:1,__:[22]})]),_:1}),a(j,null,{default:r(()=>[t("form",{onSubmit:M(oe,["prevent"]),class:"space-y-4"},[t("div",null,[a(J,{for:"rejection_reason"},{default:r(()=>e[23]||(e[23]=[d("Rejection Reason *")])),_:1,__:[23]}),Y(t("textarea",{id:"rejection_reason","onUpdate:modelValue":e[2]||(e[2]=o=>u(b).rejection_reason=o),class:"w-full rounded-md border border-input bg-transparent px-3 py-2 mt-1 text-foreground dark:bg-input/30 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] focus-visible:outline-none",rows:"4",placeholder:"Please provide a reason for rejecting this order...",required:""},null,512),[[Q,u(b).rejection_reason]])]),t("div",vt,[a(u(C),{type:"button",variant:"ghost",onClick:e[3]||(e[3]=o=>{$.value=!1,u(b).reset()})},{default:r(()=>e[24]||(e[24]=[d(" Cancel ")])),_:1,__:[24]}),a(u(C),{type:"submit",variant:"default",disabled:u(b).processing},{default:r(()=>e[25]||(e[25]=[d(" Reject Order ")])),_:1,__:[25]},8,["disabled"])])],32)]),_:1})]),_:1})])):f("",!0)]),_:1}))}});export{Pt as default};
