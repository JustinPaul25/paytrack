import{d as de,v as ce,m as I,D as z,s as me,p as q,q as pe,A as fe,c as y,o as l,w as n,a,b as t,e as c,f as p,u,g as _e,t as i,S as H,h as d,n as W,F as L,r as M,E as Y,x as Q,y as G,W as J}from"./app-DFV75mBf.js";import{_ as k}from"./index-Cq-jLiLx.js";import{p as ve,q as ge,r as ye,_ as xe}from"./AppLayout.vue_vue_type_script_setup_true_lang-DSSSnv_7.js";import{_ as C,a as j}from"./CardContent.vue_vue_type_script_setup_true_lang-BdSOOKEE.js";import{_ as S,a as B}from"./CardTitle.vue_vue_type_script_setup_true_lang-_U7A67EF.js";import{_ as K}from"./Label.vue_vue_type_script_setup_true_lang-CrmozfEn.js";import{S as v}from"./sweetalert2.esm.all-BQIkj5Wb.js";import"./LocationInput.vue_vue_type_style_index_0_scoped_807a495d_lang-C5_-5mdN.js";import"./useForwardPropsEmits-cDFu6SMJ.js";import"./DropdownMenuTrigger.vue_vue_type_script_setup_true_lang-BbW58MAF.js";import"./createLucideIcon-B3Xwb4hu.js";import"./Teleport-DEuPysO7.js";import"./RovingFocusGroup-Du4voUoU.js";import"./VisuallyHidden-D7jdQsi1.js";import"./x-DeaXVSEy.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-uZfJ_4qz.js";import"./chevron-right-CVvHX4TP.js";const he={class:"flex items-center justify-between mb-6"},be={class:"text-2xl font-bold"},we={class:"flex gap-2"},ke={class:"mb-6 flex items-center gap-4"},Ce={key:0,class:"bg-red-50 border border-red-200 rounded-md px-4 py-2"},je={class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},Se={class:"lg:col-span-2 space-y-6"},Be={class:"flex items-start gap-4"},Te={class:"flex-1"},Ae={class:"text-lg font-semibold"},Re={key:0,class:"text-sm text-gray-600"},$e={class:"text-sm text-gray-600 mt-1"},Oe={key:1,class:"text-sm text-gray-600"},Pe={key:2,class:"text-sm text-gray-600 mt-2"},qe={class:"text-sm whitespace-pre-wrap"},De={class:"space-y-4"},Ie={class:"flex justify-between items-start"},Ee={class:"flex-1"},Ne={class:"font-medium"},Fe={class:"text-sm text-gray-600"},Ue={key:0,class:"text-sm text-gray-600"},Ve={key:1,class:"text-sm text-red-600 font-medium mt-1"},ze={class:"text-right"},He={class:"font-medium"},We={class:"text-sm text-gray-600"},Le={class:"mt-6 pt-4 border-t"},Me={class:"flex justify-end"},Ye={class:"text-right space-y-1"},Qe={class:"text-sm text-gray-600"},Ge={class:"text-sm text-gray-600"},Je={class:"text-lg font-semibold"},Ke={class:"text-sm text-red-600 whitespace-pre-wrap"},Xe={class:"space-y-6"},Ze={class:"font-medium"},et={class:"font-medium capitalize"},tt={class:"font-medium"},st={key:0},ot={class:"font-medium"},rt={key:1},nt={class:"font-medium"},at={key:2},it={key:0,class:"space-y-4 mb-6 max-h-[400px] overflow-y-auto","data-comments-container":""},lt={class:"flex items-start justify-between mb-2"},ut={class:"font-medium text-sm"},dt={key:0,class:"text-xs text-blue-600 ml-2"},ct={key:1,class:"text-xs text-gray-600 ml-2"},mt={class:"text-xs text-gray-500"},pt={class:"text-sm whitespace-pre-wrap mt-2"},ft={key:1,class:"text-sm text-gray-500 mb-6 text-center py-4"},_t={class:"flex justify-end"},vt={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},gt={class:"flex gap-2 justify-end"},Dt=de({__name:"Show",props:{order:{},hasStockIssues:{type:Boolean}},setup(X){var F,U;const f=X,x=ce(),Z=Array.isArray((F=x.props.auth)==null?void 0:F.userRoles)&&x.props.auth.userRoles.includes("Customer"),h=Array.isArray((U=x.props.auth)==null?void 0:U.userRoles)&&(x.props.auth.userRoles.includes("Admin")||x.props.auth.userRoles.includes("Staff")),O=I(!1),b=z({rejection_reason:""}),g=z({comment:""}),m=I([...f.order.comments||[]]),s=I({...f.order});me(()=>f.order.comments,o=>{o&&Array.isArray(o)&&(o.forEach(e=>{m.value.find(r=>r.id===e.id)||m.value.push(e)}),m.value.sort((e,r)=>new Date(e.created_at).getTime()-new Date(r.created_at).getTime()))},{deep:!0});const ee=[{title:"Orders",href:"/orders"},{title:f.order.reference_number,href:`/orders/${f.order.id}`}];function te(o){switch(o){case"pending":return"bg-yellow-100 text-yellow-800";case"approved":return"bg-green-100 text-green-800";case"rejected":return"bg-red-100 text-red-800";case"cancelled":return"bg-gray-100 text-gray-800";default:return"bg-gray-100 text-gray-800"}}function R(o){return new Intl.NumberFormat("en-PH",{style:"currency",currency:"PHP",minimumFractionDigits:2}).format(o)}function D(o){return new Date(o).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}function E(o){if(!o.media||o.media.length===0)return null;const e=o.media.find(r=>r.mime_type&&r.mime_type.startsWith("image/"));return e?e.thumb_url||e.original_url:null}function se(o){return o.name.split(" ").map(e=>e.charAt(0)).join("").toUpperCase().slice(0,2)}function N(o){const e=[];return o.address&&e.push(o.address),o.purok&&e.push(`Purok ${o.purok}`),o.barangay&&e.push(`Barangay ${o.barangay}`),o.city_municipality&&e.push(o.city_municipality),o.province&&e.push(o.province),e.length>0?e.join(", "):""}function oe(){v.fire({title:"Approve this order?",text:"This will check product availability, deduct stock, and create an invoice.",icon:"question",showCancelButton:!0,confirmButtonColor:"#10b981",cancelButtonColor:"#6b7280",confirmButtonText:"Yes, approve",cancelButtonText:"Cancel"}).then(o=>{o.isConfirmed&&J.post(route("orders.approve",f.order.id),{},{preserveScroll:!0,onSuccess:()=>{v.fire({toast:!0,position:"top-end",icon:"success",title:"Order approved",text:"Invoice has been created successfully.",showConfirmButton:!1,timer:3e3,timerProgressBar:!0})},onError:e=>{v.fire({icon:"error",title:"Approval failed",text:e.stock||"Unable to approve order. Please check product availability."})}})})}function re(){if(!b.rejection_reason.trim()){v.fire({icon:"warning",title:"Rejection reason required",text:"Please provide a reason for rejecting this order."});return}v.fire({title:"Reject this order?",text:"This action cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#ef4444",cancelButtonColor:"#6b7280",confirmButtonText:"Yes, reject",cancelButtonText:"Cancel"}).then(o=>{o.isConfirmed&&b.post(route("orders.reject",f.order.id),{preserveScroll:!0,onSuccess:()=>{O.value=!1,b.reset(),v.fire({toast:!0,position:"top-end",icon:"success",title:"Order rejected",showConfirmButton:!1,timer:3e3,timerProgressBar:!0})}})})}function ne(){v.fire({title:"Cancel this order?",text:"This action cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#ef4444",cancelButtonColor:"#6b7280",confirmButtonText:"Yes, cancel",cancelButtonText:"No"}).then(o=>{o.isConfirmed&&J.post(route("orders.cancel",f.order.id),{},{preserveScroll:!0,onSuccess:()=>{v.fire({toast:!0,position:"top-end",icon:"success",title:"Order cancelled",showConfirmButton:!1,timer:3e3,timerProgressBar:!0})}})})}const P=q(()=>f.hasStockIssues!==void 0?f.hasStockIssues:s.value.order_items.some(o=>o.quantity>o.product.stock));q(()=>h&&s.value.status==="pending"&&!P.value);const ae=q(()=>h&&s.value.status==="pending"),ie=q(()=>(Z||h)&&s.value.status==="pending");function le(){var r,_;if(!g.comment.trim()){v.fire({icon:"warning",title:"Comment required",text:"Please enter a comment."});return}(r=x.props.auth)==null||r.user;const o=((_=x.props.auth)==null?void 0:_.userRoles)||[];o.includes("Admin")||o.includes("Staff");const e=g.comment;g.post(route("orders.comments.store",f.order.id),{preserveScroll:!0,onSuccess:$=>{const w=$.props.order;if(w!=null&&w.comments&&Array.isArray(w.comments)){const V=w.comments.find(A=>A.comment===e&&!m.value.find(ue=>ue.id===A.id));V?(m.value.push(V),setTimeout(()=>{const A=document.querySelector("[data-comments-container]");A&&(A.scrollTop=A.scrollHeight)},100)):w.comments.length>m.value.length&&(m.value=[...w.comments])}g.reset(),v.fire({toast:!0,position:"top-end",icon:"success",title:"Comment added",showConfirmButton:!1,timer:2e3,timerProgressBar:!0})},onError:$=>{console.error("Error adding comment:",$)}})}let T=null;return pe(()=>{if(!window.Echo){console.warn("Laravel Echo not initialized. Real-time updates will not work.");return}try{const o=`order.${f.order.id}`;console.log("ðŸ“¡ Subscribing to channel:",o),T=window.Echo.channel(o),T?console.log("âœ… Channel object created:",o):console.error("âŒ Failed to create channel:",o),T.listen(".order.updated",e=>{if(console.log("ðŸ”„ Received order.updated event:",e),e.order){const r=s.value.status;s.value.status=e.order.status,s.value.rejection_reason=e.order.rejection_reason,s.value.approved_at=e.order.approved_at,s.value.updated_at=e.order.updated_at,e.order.approved_by&&(s.value.approved_by={id:e.order.approved_by.id,name:e.order.approved_by.name}),e.order.invoice&&(s.value.invoice={id:e.order.invoice.id,reference_number:e.order.invoice.reference_number}),e.order.status!==r&&v.fire({toast:!0,position:"top-end",icon:"info",title:`Order ${e.order.status}`,text:`Order ${s.value.reference_number} has been ${e.order.status}`,showConfirmButton:!1,timer:3e3,timerProgressBar:!0})}}),T.listen(".comment.added",e=>{var r;console.log("ðŸ”” Received comment.added event:",e),e.comment&&!m.value.find(_=>_.id===e.comment.id)?(console.log("Adding new comment to list:",e.comment),m.value.push(e.comment),m.value.sort((_,$)=>new Date(_.created_at).getTime()-new Date($.created_at).getTime()),setTimeout(()=>{const _=document.querySelector("[data-comments-container]");_&&(_.scrollTop=_.scrollHeight)},100)):console.log("Comment already exists, skipping:",(r=e.comment)==null?void 0:r.id)}),T.listen("OrderCommentAdded",e=>{console.log("ðŸ”” Received OrderCommentAdded event:",e),e.comment&&!m.value.find(r=>r.id===e.comment.id)&&(console.log("Adding new comment to list:",e.comment),m.value.push(e.comment),m.value.sort((r,_)=>new Date(r.created_at).getTime()-new Date(_.created_at).getTime()),setTimeout(()=>{const r=document.querySelector("[data-comments-container]");r&&(r.scrollTop=r.scrollHeight)},100))})}catch(o){console.error("Error setting up Echo channel:",o)}}),fe(()=>{T&&window.Echo&&window.Echo.leave(`order.${f.order.id}`)}),(o,e)=>(l(),y(xe,{breadcrumbs:ee},{default:n(()=>[a(u(_e),{title:`Order ${s.value.reference_number}`},null,8,["title"]),t("div",he,[t("h1",be,"Order "+i(s.value.reference_number),1),t("div",we,[a(u(H),{href:o.route("orders.index")},{default:n(()=>[a(u(k),{variant:"ghost"},{default:n(()=>e[4]||(e[4]=[d("Back to Orders")])),_:1,__:[4]})]),_:1},8,["href"]),ie.value?(l(),y(u(k),{key:0,variant:"outline",onClick:ne},{default:n(()=>e[5]||(e[5]=[d(" Cancel Order ")])),_:1,__:[5]})):p("",!0),ae.value?(l(),y(u(k),{key:1,variant:"outline",onClick:e[0]||(e[0]=r=>O.value=!0)},{default:n(()=>e[6]||(e[6]=[d(" Reject Order ")])),_:1,__:[6]})):p("",!0),u(h)&&s.value.status==="pending"?(l(),y(u(k),{key:2,variant:"default",disabled:P.value,onClick:oe,title:P.value?"Cannot approve order due to insufficient stock. Please communicate with customer or adjust quantities.":""},{default:n(()=>e[7]||(e[7]=[d(" Approve Order ")])),_:1,__:[7]},8,["disabled","title"])):p("",!0)])]),t("div",ke,[t("span",{class:W(["px-3 py-1 rounded-full text-sm font-medium",te(s.value.status)])},i(s.value.status.charAt(0).toUpperCase()+s.value.status.slice(1)),3),u(h)&&P.value&&s.value.status==="pending"?(l(),c("div",Ce,e[8]||(e[8]=[t("p",{class:"text-sm text-red-800"},[t("strong",null,"âš ï¸ Warning:"),d(" This order has insufficient stock. Please communicate with the customer using the comments section below before approving. ")],-1)]))):p("",!0)]),t("div",je,[t("div",Se,[a(C,null,{default:n(()=>[a(S,null,{default:n(()=>[a(B,null,{default:n(()=>e[9]||(e[9]=[d("Customer Information")])),_:1,__:[9]})]),_:1}),a(j,null,{default:n(()=>[t("div",Be,[a(ve,{class:"h-16 w-16"},{default:n(()=>[E(s.value.customer)?(l(),y(ge,{key:0,src:E(s.value.customer),alt:s.value.customer.name},null,8,["src","alt"])):(l(),y(ye,{key:1},{default:n(()=>[d(i(se(s.value.customer)),1)]),_:1}))]),_:1}),t("div",Te,[t("h3",Ae,i(s.value.customer.name),1),s.value.customer.company_name?(l(),c("p",Re,i(s.value.customer.company_name),1)):p("",!0),t("p",$e,i(s.value.customer.email),1),s.value.customer.phone?(l(),c("p",Oe,i(s.value.customer.phone),1)):p("",!0),N(s.value.customer)?(l(),c("p",Pe,i(N(s.value.customer)),1)):p("",!0)])])]),_:1})]),_:1}),s.value.notes?(l(),y(C,{key:0},{default:n(()=>[a(S,null,{default:n(()=>[a(B,null,{default:n(()=>e[10]||(e[10]=[d("Notes")])),_:1,__:[10]})]),_:1}),a(j,null,{default:n(()=>[t("p",qe,i(s.value.notes),1)]),_:1})]),_:1})):p("",!0),a(C,null,{default:n(()=>[a(S,null,{default:n(()=>[a(B,null,{default:n(()=>e[11]||(e[11]=[d("Order Items")])),_:1,__:[11]})]),_:1}),a(j,null,{default:n(()=>[t("div",De,[(l(!0),c(L,null,M(s.value.order_items,r=>(l(),c("div",{key:r.id,class:"border rounded-md p-4"},[t("div",Ie,[t("div",Ee,[t("h4",Ne,i(r.product.name),1),t("p",Fe,"Quantity: "+i(r.quantity),1),u(h)?(l(),c("p",Ue,"Stock Available: "+i(r.product.stock),1)):p("",!0),u(h)&&r.quantity>r.product.stock?(l(),c("p",Ve," âš ï¸ Insufficient stock! (Requested: "+i(r.quantity)+", Available: "+i(r.product.stock)+") ",1)):p("",!0)]),t("div",ze,[t("p",He,i(R(r.price))+" each",1),t("p",We,"Total: "+i(R(r.total)),1)])])]))),128))]),t("div",Le,[t("div",Me,[t("div",Ye,[t("div",Qe,"Subtotal: "+i(R(s.value.subtotal_amount)),1),t("div",Ge,"VAT ("+i(s.value.vat_rate)+"%): "+i(R(s.value.vat_amount)),1),t("div",Je,"Total: "+i(R(s.value.total_amount)),1)])])])]),_:1})]),_:1}),s.value.status==="rejected"&&s.value.rejection_reason?(l(),y(C,{key:1},{default:n(()=>[a(S,null,{default:n(()=>[a(B,{class:"text-red-600"},{default:n(()=>e[12]||(e[12]=[d("Rejection Reason")])),_:1,__:[12]})]),_:1}),a(j,null,{default:n(()=>[t("p",Ke,i(s.value.rejection_reason),1)]),_:1})]),_:1})):p("",!0)]),t("div",Xe,[a(C,null,{default:n(()=>[a(S,null,{default:n(()=>[a(B,null,{default:n(()=>e[13]||(e[13]=[d("Order Information")])),_:1,__:[13]})]),_:1}),a(j,{class:"space-y-3"},{default:n(()=>[t("div",null,[e[14]||(e[14]=t("p",{class:"text-sm text-gray-600"},"Reference Number",-1)),t("p",Ze,i(s.value.reference_number),1)]),t("div",null,[e[15]||(e[15]=t("p",{class:"text-sm text-gray-600"},"Delivery Type",-1)),t("p",et,i(s.value.delivery_type),1)]),t("div",null,[e[16]||(e[16]=t("p",{class:"text-sm text-gray-600"},"Created At",-1)),t("p",tt,i(D(s.value.created_at)),1)]),s.value.approved_at?(l(),c("div",st,[e[17]||(e[17]=t("p",{class:"text-sm text-gray-600"},"Approved At",-1)),t("p",ot,i(D(s.value.approved_at)),1)])):p("",!0),s.value.approved_by?(l(),c("div",rt,[e[18]||(e[18]=t("p",{class:"text-sm text-gray-600"},"Approved By",-1)),t("p",nt,i(s.value.approved_by.name),1)])):p("",!0),s.value.invoice?(l(),c("div",at,[e[19]||(e[19]=t("p",{class:"text-sm text-gray-600"},"Invoice",-1)),a(u(H),{href:o.route("invoices.show",s.value.invoice.id),class:"font-medium text-blue-600 hover:underline"},{default:n(()=>[d(i(s.value.invoice.reference_number),1)]),_:1},8,["href"])])):p("",!0)]),_:1})]),_:1}),a(C,null,{default:n(()=>[a(S,null,{default:n(()=>[a(B,null,{default:n(()=>e[20]||(e[20]=[d("Comments")])),_:1,__:[20]})]),_:1}),a(j,null,{default:n(()=>[m.value.length>0?(l(),c("div",it,[(l(!0),c(L,null,M(m.value,r=>(l(),c("div",{key:r.id,class:W(["border rounded-md p-3",r.is_staff_comment?"bg-blue-50 border-blue-200":"bg-gray-50 border-gray-200"])},[t("div",lt,[t("div",null,[t("p",ut,[d(i(r.user.name)+" ",1),r.is_staff_comment?(l(),c("span",dt,"(Staff)")):(l(),c("span",ct,"(Customer)"))]),t("p",mt,i(D(r.created_at)),1)])]),t("p",pt,i(r.comment),1)],2))),128))])):(l(),c("div",ft," No comments yet. Start the conversation below. ")),t("form",{onSubmit:Y(le,["prevent"]),class:"space-y-3"},[t("div",null,[a(K,{for:"comment",class:"text-sm"},{default:n(()=>e[21]||(e[21]=[d("Add a comment")])),_:1,__:[21]}),Q(t("textarea",{id:"comment","onUpdate:modelValue":e[1]||(e[1]=r=>u(g).comment=r),class:"w-full rounded-md border border-input bg-transparent px-3 py-2 mt-1 text-sm text-foreground dark:bg-input/30 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] focus-visible:outline-none",rows:"3",placeholder:"Type your message here...",required:""},null,512),[[G,u(g).comment]])]),t("div",_t,[a(u(k),{type:"submit",variant:"default",size:"sm",disabled:u(g).processing},{default:n(()=>[d(i(u(g).processing?"Posting...":"Post Comment"),1)]),_:1},8,["disabled"])])],32)]),_:1})]),_:1})])]),O.value?(l(),c("div",vt,[a(C,{class:"w-full max-w-md mx-4"},{default:n(()=>[a(S,null,{default:n(()=>[a(B,null,{default:n(()=>e[22]||(e[22]=[d("Reject Order")])),_:1,__:[22]})]),_:1}),a(j,null,{default:n(()=>[t("form",{onSubmit:Y(re,["prevent"]),class:"space-y-4"},[t("div",null,[a(K,{for:"rejection_reason"},{default:n(()=>e[23]||(e[23]=[d("Rejection Reason *")])),_:1,__:[23]}),Q(t("textarea",{id:"rejection_reason","onUpdate:modelValue":e[2]||(e[2]=r=>u(b).rejection_reason=r),class:"w-full rounded-md border border-input bg-transparent px-3 py-2 mt-1 text-foreground dark:bg-input/30 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] focus-visible:outline-none",rows:"4",placeholder:"Please provide a reason for rejecting this order...",required:""},null,512),[[G,u(b).rejection_reason]])]),t("div",gt,[a(u(k),{type:"button",variant:"ghost",onClick:e[3]||(e[3]=r=>{O.value=!1,u(b).reset()})},{default:n(()=>e[24]||(e[24]=[d(" Cancel ")])),_:1,__:[24]}),a(u(k),{type:"submit",variant:"default",disabled:u(b).processing},{default:n(()=>e[25]||(e[25]=[d(" Reject Order ")])),_:1,__:[25]},8,["disabled"])])],32)]),_:1})]),_:1})])):p("",!0)]),_:1}))}});export{Dt as default};
